import { useState, useEffect } from 'react';
import { getFilterList } from '@/util/qlikConnection';
import './ComboBox.css';

export default function ComboBox({ app, onChange }) {
  const [selectedValue, setSelectedValue] = useState('');
  const [options, setOptions] = useState([]);
  const [cardTitles, setCardTitles] = useState([]); // Başlıkları tutacağımız array

  const objectIds = ["objectId1", "objectId2", "objectId3", "objectId4"]; // ID'leri burada tanımlıyoruz

  const renderQlikTableObject = (objectId) => {    
    if (app) {          
      app.getObject(objectId).then((model) => {
        let titles = model.layout.title.trim();
        if(titles === "") {
          if(model.genericType == "table"){
            titles = model.layout.qHyperCube.qDimensionInfo[0].qFallbackTitle;
         }
         else if(model.genericType == "linechart"){
            titles = model.layout.title;
         }
         else if(model.genericType== "action-button"){
           titles = model.layout.style.label;
         }
        }  
        
        // Başlıkları array'e ekliyoruz
        setCardTitles((prevTitles) => [...prevTitles, titles]);
      });
    }
  }

  useEffect(() => {
    // objectIds array'i üzerinde döngü kurarak her bir ID için renderQlikTableObject fonksiyonunu çağırıyoruz
    objectIds.forEach(objectId => {
      renderQlikTableObject(objectId);
    });
  }, [app]); // app değiştiğinde çalışacak şekilde useEffect'i ayarlıyoruz.

  useEffect(() => {
    // Eğer options array'imizde bir şey varsa ve seçili bir seçenek varsa onu set et
    const selectedOption = options.find((option) => option.qState === 'S');
    if (selectedOption) {
      setSelectedValue(selectedOption.text);
    }
  }, [options]);

  const handleChange = (event) => {
    const newValue = event.target.value;
    setSelectedValue(newValue);
    onChange(newValue); // Burada diğer parametreler yerine sadece newValue gönderiyoruz
  };

  const truncateText = (text, maxLength = 30) => {
    return text.length > maxLength ? text.slice(0, maxLength) + '...' : text;
  };

  return (
    cardTitles.length > 0 ? (  // Başlıklar var ise render et
      <div className="combobox-container ml-2">
        <select
          value={selectedValue}
          onChange={handleChange}
          className="combobox"
        >
          {cardTitles.map((title, index) => (
            <option
              key={index}
              value={title}
              className="combobox-option"
              title={title} // Full text as a tooltip
            >
              {truncateText(title)}
            </option>
          ))}
        </select>
      </div>
    ) : (
      <></>
    )
  );
}
